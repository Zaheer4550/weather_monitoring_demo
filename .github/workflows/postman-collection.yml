  export-last-24h:
    runs-on: ubuntu-latest
    needs: trigger-and-export   # optional; remove if you want it independent
    env:
      API_KEY: ${{ secrets.POSTMAN_API_KEY }}
      MONITOR_UID: ${{ secrets.POSTMAN_MONITOR_UID }}
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Compute last 24h window (UTC)
        id: win
        run: |
          END=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          START=$(date -u -d '24 hours ago' +"%Y-%m-%dT%H:%M:%SZ")
          echo "start=$START" >> $GITHUB_OUTPUT
          echo "end=$END" >> $GITHUB_OUTPUT
          echo "Window: $START to $END"

      - name: Fetch recent results (JSON)
        run: |
          mkdir -p export24
          # pull a generous page; loop/paginate if you need more history
          curl -sS -H "X-Api-Key: $API_KEY" \
            "https://api.getpostman.com/monitors/${MONITOR_UID}/results?count=1000" \
            -o export24/runs_raw.json

      - name: Filter to last 24h and build CSV + per-region files
        run: |
          START="${{ steps.win.outputs.start }}"
          END="${{ steps.win.outputs.end }}"
          jq --arg start "$START" --arg end "$END" '
            .results
            | map(select(.startedAt >= $start and .startedAt < $end))
          ' export24/runs_raw.json > export24/runs_24h.json

          # CSV (all regions)
          jq -r '
            ["resultId","region","status","startedAt","finishedAt","avgResponseMs","failedCount","totalCount"],
            ( .[] | [
              .id, .region, .status, .startedAt, .finishedAt,
              (.summary.responseTimeAvg // .responseTime // null),
              (.summary.assertions.failed // 0),
              (.summary.assertions.total // 0)
            ]) | @csv
          ' export24/runs_24h.json > export24/runs_24h.csv

          # Split per region (auto-detect unique regions)
          mkdir -p export24/by-region
          for r in $(jq -r '.[].region' export24/runs_24h.json | sort -u); do
            jq --arg r "$r" 'map(select(.region==$r))' \
              export24/runs_24h.json > export24/by-region/runs_24h_$r.json
            jq -r '
              ["resultId","status","startedAt","finishedAt","avgResponseMs","failedCount","totalCount"],
              ( .[] | [
                .id, .status, .startedAt, .finishedAt,
                (.summary.responseTimeAvg // .responseTime // null),
                (.summary.assertions.failed // 0),
                (.summary.assertions.total // 0)
              ]) | @csv
            ' export24/by-region/runs_24h_$r.json > export24/by-region/runs_24h_$r.csv
          done

      - name: Upload artifacts (last 24h)
        uses: actions/upload-artifact@v4
        with:
          name: postman-monitor-last24h
          path: export24/**
