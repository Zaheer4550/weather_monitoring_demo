name: Run 3 Postman collections + trigger monitors + latency summary (per monitor only)

on:
  push:
  workflow_dispatch:

jobs:
  run-and-monitor:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        suite:
          - name: current-weather
            collection: "Get Current Weather_A.postman_collection.json"
            data:       "current_weather_cities.csv"
            monitor_uid: "45974783-1f084d67-0b9f-4bf0-8be3-5f0db8c25a4f"
          - name: daily-forecast
            collection: "Get Daily Forecast- B.postman_collection.json"
            data:       "Forecast_cities.csv"
            monitor_uid: "45974783-1f084d6c-cd8b-4f70-a56c-2c989dd363c6"
          - name: historical-data
            collection: "Get Historical Data- C.postman_collection.json"
            data:       "Historical_cities.csv"
            monitor_uid: "45974783-1f084d7b-f131-47e0-b084-7926fd355a25"

    steps:
      - uses: actions/checkout@v4

      - name: Install Node & Newman
        run: |
          sudo apt-get update -y
          sudo apt-get install -y nodejs npm jq
          npm i -g newman newman-reporter-htmlextra

      - name: Run ${{ matrix.suite.name }} via Newman (HTML + JUnit + JSON)
        run: |
          mkdir -p reports/${{ matrix.suite.name }}
          newman run "${{ matrix.suite.collection }}" \
            -d "${{ matrix.suite.data }}" \
            --reporters cli,htmlextra,json,junit \
            --reporter-htmlextra-export "reports/${{ matrix.suite.name }}/report.html" \
            --reporter-json-export       "reports/${{ matrix.suite.name }}/report.json" \
            --reporter-junit-export      "reports/${{ matrix.suite.name }}/report.junit.xml" \
            --delay-request 250

      - name: Trigger cloud monitor and fetch latest result
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        run: |
          curl -s -X POST \
            "https://api.getpostman.com/monitors/${{ matrix.suite.monitor_uid }}/run" \
            -H "X-Api-Key: $POSTMAN_API_KEY" \
            -o "reports/${{ matrix.suite.name }}/monitor_kick.json"

          sleep 20
          curl -s \
            "https://api.getpostman.com/monitors/${{ matrix.suite.monitor_uid }}/results/latest" \
            -H "X-Api-Key: $POSTMAN_API_KEY" \
            -o "reports/${{ matrix.suite.name }}/monitor_latest.json"

           - name: Extract latency for current run (multi-region)
        run: |
          json="reports/${{ matrix.suite.name }}/monitor_latest.json"

          if jq -e '.results | length > 0' "$json" > /dev/null; then
            jq -r '.results[] | [.monitor.name, .region, .timestamp, .run.info.responseTime] | @csv' \
              "$json" > "reports/${{ matrix.suite.name }}/latency.csv"

            {
              echo "<h1>Latency Report – ${{ matrix.suite.name }}</h1>"
              echo "<p><a href=\"report.html\">View Full Run Report</a></p>"
              echo "<table border=1>"
              echo "<tr><th>Monitor</th><th>Region</th><th>Timestamp</th><th>Latency (ms)</th></tr>"
              tail -n +1 "reports/${{ matrix.suite.name }}/latency.csv" | while IFS=, read monitor region ts latency; do
                echo "<tr><td>$monitor</td><td>$region</td><td>$ts</td><td>$latency</td></tr>"
              done
              echo "</table>"
            } > "reports/${{ matrix.suite.name }}/latency.html"
          else
            echo "⚠️ No latency data found for ${{ matrix.suite.name }}" > "reports/${{ matrix.suite.name }}/latency.html"
          fi
